services:
  # Rust Core Service
  jessy-core:
    build:
      context: .
      dockerfile: docker/Dockerfile.rust
      target: development
    platform: linux/arm64
    container_name: jessy-core
    volumes:
      - ./src:/app/src
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    ports:
      - "8080:8080"
    environment:
      - RUST_LOG=jessy=debug,actix_web=info
      - RUST_BACKTRACE=1
      - RUST_ENV=development
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Restart policy: unless-stopped ensures service restarts on failure
    # Docker automatically implements exponential backoff (10s, 20s, 40s, etc.)
    # Maximum backoff is 1 minute between restart attempts
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"
    labels:
      service: "jessy-core"
      environment: "development"
    networks:
      - jessy-network

  # Go API Service
  jessy-api:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
      target: development
    platform: linux/arm64
    container_name: jessy-api
    volumes:
      - ./api:/app/api
      - go-cache:/go/pkg/mod
    ports:
      - "3000:3000"
    environment:
      - GO_ENV=development
      - PORT=3000
      - RUST_SERVICE_URL=http://jessy-core:8080
      - LOG_LEVEL=debug
    depends_on:
      jessy-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Restart policy: unless-stopped ensures service restarts on failure
    # Docker automatically implements exponential backoff (10s, 20s, 40s, etc.)
    # Maximum backoff is 1 minute between restart attempts
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"
    labels:
      service: "jessy-api"
      environment: "development"
    networks:
      - jessy-network

  # Test Runner Service
  jessy-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    platform: linux/arm64
    container_name: jessy-test
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      - test-results:/app/test-results
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    environment:
      - RUST_TEST_THREADS=1
      - RUST_BACKTRACE=1
    command: ["cargo", "test", "--all-features"]
    networks:
      - jessy-network
    profiles:
      - test

volumes:
  cargo-cache:
    driver: local
  target-cache:
    driver: local
  go-cache:
    driver: local
  test-results:
    driver: local

networks:
  jessy-network:
    driver: bridge

# Implementation Plan - Utils Navigation Error Tracker Refactor

## Task List

- [ ] 1. Set up project structure and dependencies
  - Create `prod-xnaut-core-rewrite/rust/navigation_error_tracker` crate with proper Cargo.toml
  - Add dependencies: rclrs, serde, thiserror, tracing
  - Set up module structure: lib.rs, node.rs, distance.rs, validation.rs, config.rs, types.rs
  - Configure clippy and rustfmt settings to match existing drone driver standards
  - _Requirements: 6.1, 6.3_

- [ ] 2. Implement core data types and configuration
  - [ ] 2.1 Define common types in types.rs
    - Create NavigationError struct (horizontal_distance, height_difference)
    - Define error types: DistanceError, ValidationError, ProcessingError, NodeError
    - Implement Display and Error traits for all error types
    - Add constants for Earth radius and validation thresholds
    - _Requirements: 4.4, 3.1, 3.2, 3.3_
  - [ ] 2.2 Implement configuration in config.rs
    - Create NavigationErrorTrackerConfig struct with inputs, outputs, sync_tolerance
    - Add serde Deserialize for YAML loading
    - Implement validation logic for configuration parameters
    - Add default values matching Python implementation
    - Create config loading function with error handling
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 4.4_
  - [ ]* 2.3 Write unit tests for configuration
    - Test YAML deserialization with valid config
    - Test validation logic with invalid parameters
    - Test default value initialization
    - _Requirements: 7.1_

- [ ] 3. Implement geodesic distance calculation
  - [ ] 3.1 Implement Haversine formula in distance.rs
    - Write `geodesic_distance` function using Haversine formula
    - Write `height_difference` function
    - Write `calculate_navigation_error` function combining both
    - Add inline documentation with mathematical formulas
    - Use f64 for all calculations (Python compatibility)
    - _Requirements: 1.1, 1.2, 1.3, 1.5, 8.3_
  - [ ] 3.2 Write comprehensive unit tests for distance calculation
    - Test with known coordinates and expected distances
    - Test edge cases (poles, equator, antimeridian)
    - Test numerical precision (tolerance 1e-6 meters)
    - Test height difference calculation
    - Verify matches Python geopy.distance.geodesic results
    - _Requirements: 7.1, 7.3, 4.5_

- [ ] 4. Implement validation module
  - [ ] 4.1 Implement input validation functions in validation.rs
    - Write `validate_navsatfix` to validate NavSatFix message
    - Write `is_valid_coordinate` helper function
    - Write `is_valid_altitude` helper function
    - Handle NaN values appropriately
    - Handle out-of-range coordinates
    - Add appropriate error types and logging
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [ ]* 4.2 Write unit tests for validation
    - Test valid inputs pass through correctly
    - Test NaN detection in latitude, longitude, altitude
    - Test out-of-range coordinate detection
    - Test error message formatting
    - _Requirements: 7.2_

- [ ] 5. Implement message synchronization
  - [ ] 5.1 Create message synchronizer in node.rs
    - Define MessageSynchronizer struct with VecDeque for both message types
    - Implement `add_message1` and `add_message2` methods
    - Implement `find_synchronized_pair` with time tolerance matching
    - Add queue size limits to prevent unbounded growth
    - Add logging for dropped messages
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [ ]* 5.2 Write unit tests for message synchronization
    - Test exact timestamp matching
    - Test approximate matching within tolerance
    - Test queue overflow handling
    - Test message dropping for old messages
    - _Requirements: 7.1_

- [ ] 6. Implement ROS2 node
  - [ ] 6.1 Create NavigationErrorTrackerNode struct in node.rs
    - Define node structure with subscribers, publisher, config, sync
    - Implement `new` constructor with ROS2 node initialization
    - Create subscribers for fix and ground truth topics
    - Create publisher for error topic
    - Initialize message synchronizer
    - Integrate with error manager and performance monitor
    - Add atomic counters for statistics (valid_count, invalid_count)
    - _Requirements: 1.1, 1.2, 4.1, 4.2, 4.3_
  - [ ] 6.2 Implement message processing pipeline
    - Write fix callback to add message to synchronizer
    - Write ground truth callback to add message to synchronizer
    - Write `synchronized_callback` to process matched message pairs
    - Write `process_messages` to calculate error
    - Write `build_error_message` to construct PointStamped output
    - Add error handling and logging throughout
    - _Requirements: 1.3, 1.4, 1.5, 2.3, 2.4, 2.5_
  - [ ] 6.3 Implement diagnostics and error reporting
    - Add diagnostic status publishing
    - Track metrics (valid count, invalid count, processing rate)
    - Integrate with centralized error management
    - Add warning logs for invalid data
    - Add error logs for processing failures
    - _Requirements: 3.5, 2.5_
  - [ ]* 6.4 Write integration tests for ROS2 node
    - Test node initialization and configuration loading
    - Test message subscription and publishing
    - Test synchronized callback execution
    - Test diagnostic message publishing
    - _Requirements: 7.3_

- [ ] 7. Implement backward compatibility validation
  - [ ] 7.1 Create Python test vector generation
    - Create script to run Python implementation with test inputs
    - Generate comprehensive test cases (various coordinates, edge cases)
    - Save test vectors to JSON (inputs + expected outputs)
    - Include edge cases (NaN, out of range, poles, equator)
    - _Requirements: 4.5, 7.3, 7.5_
  - [ ] 7.2 Implement compatibility tests in Rust
    - Load Python test vectors from JSON
    - Process through Rust implementation
    - Compare outputs (must match within 1e-6 meters)
    - Test all edge cases
    - Verify 100% compatibility
    - _Requirements: 4.5, 7.3, 7.5_

- [ ] 8. Create configuration and launch files
  - [ ] 8.1 Create YAML configuration file
    - Create `prod-xnaut-core-rewrite/config/navigation_error_tracker.yaml`
    - Set topic names matching Python implementation
    - Set default sync tolerance
    - Add comments explaining each parameter
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 4.1, 4.2, 4.3, 4.4_
  - [ ] 8.2 Create launch file
    - Create `prod-xnaut-core-rewrite/launch/navigation_error_tracker.launch.py`
    - Load configuration from YAML file
    - Set node name matching Python implementation
    - Add launch arguments for configuration overrides
    - Add comments and documentation
    - _Requirements: 6.3, 4.1, 4.2, 4.3_
  - [ ] 8.3 Create hybrid side-by-side launch file
    - Create launch file to run both Python and Rust implementations
    - Use unique node names to avoid conflicts
    - Publish to different output topics for comparison
    - Add validation node to compare outputs in real-time
    - _Requirements: 4.5, 7.3_

- [ ] 9. Implement performance benchmarks
  - [ ] 9.1 Create latency benchmarks
    - Create `benches/tracker_bench.rs` using criterion
    - Benchmark single message pair processing
    - Benchmark distance calculation only
    - Benchmark with various coordinate combinations
    - Measure execution time variance
    - _Requirements: 5.1, 5.2, 7.4_
  - [ ] 9.2 Create comparison benchmarks
    - Create script to benchmark Python implementation
    - Run same test cases through both implementations
    - Compare latency (target: 2x improvement)
    - Compare throughput
    - Compare CPU usage
    - Generate comparison report
    - _Requirements: 5.4, 7.4, 7.5_
  - [ ]* 9.3 Create memory profiling
    - Verify zero runtime allocations in hot path
    - Measure total memory usage
    - Compare with Python memory usage
    - _Requirements: 5.3_

- [ ] 10. Create comprehensive documentation
  - [ ] 10.1 Create README
    - Write overview of navigation error tracker
    - Document geodesic distance calculation methodology
    - Provide usage examples
    - Document configuration parameters
    - Add troubleshooting section
    - _Requirements: 8.1, 8.2, 8.3, 8.5_
  - [ ] 10.2 Create migration guide
    - Document differences from Python implementation (if any)
    - Provide step-by-step migration instructions
    - Document validation methodology
    - Add rollback procedures
    - Include performance comparison results
    - _Requirements: 8.4, 8.5_
  - [ ] 10.3 Add inline documentation
    - Document all public functions with rustdoc comments
    - Add examples in documentation
    - Document error conditions and edge cases
    - Add mathematical formulas for distance calculation
    - _Requirements: 8.1, 8.3_

- [ ] 11. Side-by-side validation
  - [ ] 11.1 Run side-by-side validation
    - Launch hybrid side-by-side configuration
    - Publish test messages to both implementations
    - Collect output from both nodes
    - Compare outputs with validation script
    - Verify 100% compatibility (within tolerance)
    - Document any discrepancies and fix
    - _Requirements: 4.5, 7.3, 7.5_
  - [ ] 11.2 Run performance validation
    - Execute all benchmarks
    - Verify latency < 200μs target
    - Verify variance < 20μs target
    - Verify 2x performance improvement over Python
    - Verify zero runtime allocations
    - Generate performance report
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [ ]* 11.3 Run extended testing
    - Test with high message rates (100Hz)
    - Test with continuous operation (24+ hours)
    - Monitor for memory leaks
    - Monitor for performance degradation
    - Test recovery from error conditions
    - _Requirements: 5.5_

- [ ] 12. Integration with existing system
  - [ ] 12.1 Update build system
    - Add navigation_error_tracker crate to workspace Cargo.toml
    - Update CMakeLists.txt for ROS2 package
    - Add to CI/CD pipeline
    - _Requirements: 6.3_
  - [ ] 12.2 Update system launch files
    - Add navigation error tracker node to main system launch file
    - Add feature flag to switch between Python and Rust
    - Update documentation for launch file changes
    - _Requirements: 6.3_
  - [ ] 12.3 Create deployment documentation
    - Document deployment procedure
    - Document validation checklist
    - Document monitoring and alerting
    - Document rollback procedure
    - _Requirements: 8.4_

## Notes

- Tasks marked with `*` are optional testing tasks that can be skipped for faster MVP
- Each task references specific requirements from requirements.md
- Tasks are designed to be completed incrementally with validation at each step
- Side-by-side validation (task 11.1) is important before production deployment
- This is a simple component - total implementation time: 1-2 weeks
